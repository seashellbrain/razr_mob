<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî Polar</title>

    <!-- –æ–±—â–∏–π —Å—Ç–∏–ª—å –ø—Ä–æ–µ–∫—Ç–∞ -->
    <link rel="stylesheet" href="../css/main.css" />

    <!-- –Ω–µ–º–Ω–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤—ë—Ä—Å—Ç–∫–∏ –¥–ª—è —Å–µ—Ç–∫–∏ –∏ —Å–µ–ª–µ–∫—Ç–æ–≤ -->
    <style>
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin: 8px 0 16px;
        }

        .picker {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .picker select {
            padding: .55rem .7rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: transparent;
            color: inherit
        }

        .row-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        .summary {
            font-weight: 800;
            font-size: 1.25rem
        }

        .muted {
            opacity: .7;
            font-size: .9rem
        }

        /* —Å–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫: –≤–æ–∑—å–º–∏ –∫–ª–∞—Å—Å—ã –∏–∑ main.css –∏ –¥–æ–∫—Ä—É—Ç–∏ –∞–¥–∞–ø—Ç–∏–≤ */
        .stats-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr))
        }

        @media (max-width:768px) {
            .stats-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body class="home">
    <!-- —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ ‚Äú–®–∞–±–ª–æ–Ω—ã —Å–º–µ–Ω‚Äù -->
    <div class="page-bg"></div>

    <header class="header container">
        <a href="index.html" class="logo">Polar</a>
        <nav class="nav">
            <a href="home.html">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
            <a href="register.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </nav>
    </header>

    <main class="container">
        <section class="glass">
            <div class="topbar">
                <h1 class="page-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                <div class="picker">
                    <label>–ú–µ—Å—è—Ü</label>
                    <select id="monthSel" aria-label="–ú–µ—Å—è—Ü"></select>
                    <label>–ì–æ–¥</label>
                    <select id="yearSel" aria-label="–ì–æ–¥"></select>
                    <button class="btn btn--primary" id="clearMonth" type="button">–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—è—Ü</button>
                </div>
            </div>

            <div class="stats-grid">
                <!-- –ó–∞—Ä–∞–±–æ—Ç–æ–∫ -->
                <section class="panel">
                    <div class="row-head">
                        <div>
                            <h2>ü™ô –ó–∞—Ä–∞–±–æ—Ç–æ–∫</h2>
                            <div class="muted">–í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü</div>
                        </div>
                        <div class="summary"><span id="sumMoney">0</span> Br</div>
                    </div>
                    <div class="chart" id="chartMoney" aria-label="–ó–∞—Ä–∞–±–æ—Ç–æ–∫ –ø–æ –Ω–µ–¥–µ–ª—è–º"></div>
                </section>

                <!-- –†–∞–±–æ—á–∏–µ —á–∞—Å—ã -->
                <section class="panel">
                    <div class="row-head">
                        <div>
                            <h2>‚è∞ –†–∞–±–æ—á–∏–µ —á–∞—Å—ã</h2>
                            <div class="muted">–í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü</div>
                        </div>
                        <div class="summary"><span id="sumHours">0</span> —á</div>
                    </div>
                    <div class="chart chart--hours" id="chartHours" aria-label="–ß–∞—Å—ã –ø–æ –Ω–µ–¥–µ–ª—è–º"></div>
                </section>

                <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–º–µ–Ω -->
                <section class="panel" style="grid-column:1/-1">
                    <div class="row-head">
                        <div>
                            <h2>üß± –°–º–µ–Ω—ã</h2>
                            <div class="muted">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</div>
                        </div>
                        <div class="summary" id="topShift">‚Äî</div>
                    </div>
                    <div class="chart chart--shifts" id="chartShifts" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–º–µ–Ω –ø–æ —Ç–∏–ø–∞–º"></div>
                </section>
            </div>

  <div class="bottombar">
    <a class="btn1" href="home.html">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a class="btn1" href="shifts.html">–°–º–µ–Ω—ã</a>
    <a class="btn1" href="stats.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
  </div>
        </section>
    </main>

    <script>
 
        (function () {
            const $ = (s, r = document) => r.querySelector(s);
            const monthSel = $("#monthSel");
            const yearSel = $("#yearSel");

            const now = new Date();
     
            [now.getFullYear() - 1, now.getFullYear(), now.getFullYear() + 1].forEach(y => {
                const o = document.createElement("option"); o.value = y; o.textContent = y; yearSel.appendChild(o);
            });
      
            Array.from({ length: 12 }, (_, i) => new Date(2025, i, 1).toLocaleString("ru-RU", { month: "long" }))
                .forEach((label, i) => {
                    const m = String(i + 1).padStart(2, "0"); const o = document.createElement("option");
                    o.value = m; o.textContent = label; monthSel.appendChild(o);
                });

 
            let defY = now.getFullYear(), defM = String(now.getMonth() + 1).padStart(2, "0");
            for (let i = 0; i < 12; i++) {
                const m = String(now.getMonth() + 1 - i).padStart(2, "0"); const y = now.getFullYear();
                if (localStorage.getItem("polar_shifts_" + y + "_" + m)) { defY = y; defM = m; break; }
            }
            yearSel.value = defY; monthSel.value = defM;

            function parseRec(rec) {
                const pay = rec.pay || "hourly"; const hours = Number(rec.hours || 0); const rate = Number(rec.rate || 0);
                const total = pay === "hourly" ? hours * rate : (pay === "fixed" ? rate : 0);
                return { hours, total, kind: rec.kind || "custom" };
            }
            function loadMonth(y, m) {
                const raw = JSON.parse(localStorage.getItem("polar_shifts_" + y + "_" + m) || "{}");
                const entries = Object.values(raw).map(parseRec);
                const sumMoney = entries.reduce((s, r) => s + r.total, 0);
                const sumHours = entries.reduce((s, r) => s + r.hours, 0);

                const days = new Date(Number(y), Number(m), 0).getDate();
                const weeks = Math.ceil(days / 7);
                const perWeekMoney = new Array(weeks).fill(0);
                const perWeekHours = new Array(weeks).fill(0);

                Object.keys(raw).forEach(k => {
                    const day = Number(k.split("-")[2] || "1");
                    const w = Math.floor((day - 1) / 7);
                    const r = parseRec(raw[k]);
                    perWeekMoney[w] += r.total; perWeekHours[w] += r.hours;
                });

                const byKind = {};
                entries.forEach(r => { byKind[r.kind] = (byKind[r.kind] || 0) + 1; });

                return { sumMoney, sumHours, perWeekMoney, perWeekHours, byKind };
            }
            function bar(el, values, labels) {
                el.innerHTML = ""; const max = Math.max(1, ...values);
                values.forEach((v, i) => {
                    const wrap = document.createElement("div"); wrap.className = "bar";
                    const col = document.createElement("div"); col.className = "bar__col";
                    col.style.height = (v / max) * 90 + 5 + "%"; col.title = String(Math.round(v * 100) / 100);
                    const lab = document.createElement("div"); lab.className = "bar__label"; lab.textContent = labels ? labels[i] : i + 1;
                    wrap.appendChild(col); wrap.appendChild(lab); el.appendChild(wrap);
                });
            }
            function update() {
                const y = yearSel.value, m = monthSel.value;
                const { sumMoney, sumHours, perWeekMoney, perWeekHours, byKind } = loadMonth(y, m);
                $("#sumMoney").textContent = (Math.round(sumMoney * 100) / 100).toFixed(1).replace(".0", "");
                $("#sumHours").textContent = (Math.round(sumHours * 10) / 10).toFixed(1).replace(".0", "");
                bar($("#chartMoney"), perWeekMoney);
                bar($("#chartHours"), perWeekHours);
                const kinds = Object.keys(byKind), counts = kinds.map(k => byKind[k]);
                const labels = kinds.map(k => ({ day: "–¥–µ–Ω—å", eve: "–≤–µ—á–µ—Ä", night: "–Ω–æ—á—å", h9: "9—á", full: "—Å—É—Ç–∫–∏", off: "off", sick: "–±–æ–ª—å–Ω." }[k] || k));
                bar($("#chartShifts"), counts, labels);
                $("#topShift").textContent = kinds.length ? `${labels[counts.indexOf(Math.max(...counts))]} ‚Äî ${Math.max(...counts)}` : "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
            }
            monthSel.addEventListener("change", update);
            yearSel.addEventListener("change", update);
            $("#clearMonth").addEventListener("click", () => {
                if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü?")) return;
                localStorage.removeItem("polar_shifts_" + yearSel.value + "_" + monthSel.value);
                update();
            });
            update();
        })();
    </script>
</body>

</html>